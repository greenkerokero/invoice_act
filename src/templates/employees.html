<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сотрудники</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .form-control, .form-select {
            border-color: #adb5bd; box-shadow: inset 0 1px 3px rgba(0,0,0,0.12);
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea; box-shadow: inset 0 1px 3px rgba(0,0,0,0.12), 0 0 0 0.2rem rgba(102,126,234,0.25);
        }
        .container { max-width: 2200px; }
        .employees-zone { background-color: #fff; border-radius: 8px; padding: 15px; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; padding-top: 0.3rem; padding-bottom: 0.3rem; }
        .navbar-brand { padding-top: 0.2rem; padding-bottom: 0.2rem; font-size: 1rem; }
        .nav-link { padding: 0.3rem 0.5rem !important; font-size: 0.9rem; }
        .nav-link.active { 
            font-weight: bold; 
            text-decoration: underline;
            background-color: rgba(255,255,255,0.15);
            border-radius: 4px;
        }

        .data-table {
            display: flex;
            flex-direction: column;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: #fff;
            overflow: hidden;
        }
        .data-header {
            display: grid;
            grid-template-columns: var(--cols);
            background-color: #e9ecef;
            font-weight: bold;
            border-bottom: 2px solid #dee2e6;
        }
        .data-row-wrapper {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #dee2e6;
        }
        .data-row {
            display: grid;
            grid-template-columns: var(--cols);
            align-items: center;
            padding: 4px 0;
        }
        .data-row:hover { background-color: #f8f9fa; }
        .data-cell {
            padding: 4px 3px 4px 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
        }
        .data-header .data-cell { white-space: nowrap; }
        .action-buttons { display: flex; gap: 4px; flex-wrap: nowrap; }
        .action-buttons .btn { white-space: nowrap; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-3">
        <div class="container">
            <a class="navbar-brand" href="/">Учет счетов и актов</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Счета</a>
                <a class="nav-link" href="/linked-acts">Привязанные акты</a>
                <a class="nav-link" href="/unlinked-acts">Непривязанные акты</a>
                <a class="nav-link" href="/import">Импорт и Настройки</a>
                <a class="nav-link active" href="/employees">Сотрудники</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="employees-zone">
            <h5 class="mb-3">Управление сотрудниками</h5>
            
<div class="row">
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6>Добавить сотрудника</h6>
                            <form id="addEmployeeForm">
                                <div class="mb-2">
                                    <input type="text" class="form-control" id="lastName" placeholder="Фамилия" required>
                                </div>
                                <div class="mb-2">
                                    <input type="text" class="form-control" id="firstName" placeholder="Имя" required>
                                </div>
                                <div class="mb-2">
                                    <input type="text" class="form-control" id="middleName" placeholder="Отчество">
                                </div>
                                <div class="mb-2">
                                    <input type="text" class="form-control" id="department" placeholder="Отдел">
                                </div>
                                <div class="mb-2">
                                    <input type="text" class="form-control" id="position" placeholder="Должность">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Добавить</button>
                            </form>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h6>Массовое добавление</h6>
                            <div class="mb-2">
                                <label class="form-label">Порядок слов:</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="nameOrder" id="nameOrderFirstName" value="first_name" checked>
                                        <label class="form-check-label" for="nameOrderFirstName">Первое имя</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="nameOrder" id="nameOrderFirstSurname" value="first_surname">
                                        <label class="form-check-label" for="nameOrderFirstSurname">Первая фамилия</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label" for="bulkEmployees">Сотрудники (каждый с новой строки):</label>
                                <small class="text-muted d-block mb-1">
                                    Формат: <b>Имя Фамилия</b> или <b>Фамилия Имя</b><br>
                                    Пример: Сергей Иванов
                                </small>
                                <textarea class="form-control" id="bulkEmployees" rows="6" placeholder="Сергей Иванов&#10;Семен Петров&#10;Анна Сидорова"></textarea>
                            </div>
                            <button type="button" class="btn btn-success w-100" onclick="addBulkEmployees()">Добавить сотрудников</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <h6>Список сотрудников</h6>
                    <div>
                        <div class="data-table" id="employeesTable" style="--cols: minmax(100px, 1.5fr) minmax(80px, 1fr) minmax(100px, 1.5fr) minmax(100px, 1.5fr) minmax(100px, 1.5fr) minmax(160px, 1.5fr);">
                            <div class="data-header">
                                <div class="data-cell">Фамилия</div>
                                <div class="data-cell">Имя</div>
                                <div class="data-cell">Отчество</div>
                                <div class="data-cell">Отдел</div>
                                <div class="data-cell">Должность</div>
                                <div class="data-cell">Действия</div>
                            </div>
                            <div id="employeesBody"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editEmployeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Редактировать сотрудника</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editEmployeeForm">
                        <input type="hidden" id="editEmployeeId">
                        <div class="mb-2">
                            <label class="form-label">Фамилия</label>
                            <input type="text" class="form-control" id="editLastName" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Имя</label>
                            <input type="text" class="form-control" id="editFirstName" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Отчество</label>
                            <input type="text" class="form-control" id="editMiddleName">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Отдел</label>
                            <input type="text" class="form-control" id="editDepartment">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Должность</label>
                            <input type="text" class="form-control" id="editPosition">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Сохранить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        let employees = [];
        
        function loadEmployees() {
            fetch('/employees/list')
                .then(res => res.json())
                .then(data => {
                    employees = data;
                    renderEmployees();
                });
        }
        
        function renderEmployees() {
            const body = document.getElementById('employeesBody');
            body.innerHTML = '';
            
            employees.sort((a, b) => (a.last_name || '').localeCompare(b.last_name || ''));
            
            employees.forEach(emp => {
                const wrapper = document.createElement('div');
                wrapper.className = 'data-row-wrapper';
                
                const row = document.createElement('div');
                row.className = 'data-row';
                row.innerHTML = `
                    <div class="data-cell">${emp.last_name || ''}</div>
                    <div class="data-cell">${emp.first_name || ''}</div>
                    <div class="data-cell">${emp.middle_name || ''}</div>
                    <div class="data-cell">${emp.department || ''}</div>
                    <div class="data-cell">${emp.position || ''}</div>
                    <div class="data-cell">
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="editEmployee(${emp.id})">Изменить</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEmployee(${emp.id})">Удалить</button>
                        </div>
                    </div>
                `;
                wrapper.appendChild(row);
                body.appendChild(wrapper);
            });
        }
        
        document.getElementById('addEmployeeForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('last_name', document.getElementById('lastName').value);
            formData.append('first_name', document.getElementById('firstName').value);
            formData.append('middle_name', document.getElementById('middleName').value);
            formData.append('department', document.getElementById('department').value);
            formData.append('position', document.getElementById('position').value);
            
            try {
                const response = await fetch('/employees/add', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('addEmployeeForm').reset();
                    loadEmployees();
                } else {
                    alert('Ошибка: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Ошибка: ' + err);
            }
        };
        
        function deleteEmployee(id) {
            if (!confirm('Вы уверены, что хотите удалить этого сотрудника?')) return;
            
            fetch('/employees/delete/' + id, { method: 'POST' })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        loadEmployees();
                    } else {
                        alert('Ошибка: ' + (result.error || 'Unknown error'));
                    }
                });
        }
        
        function addBulkEmployees() {
            const text = document.getElementById('bulkEmployees').value.trim();
            if (!text) return;
            
            const nameOrder = document.querySelector('input[name="nameOrder"]:checked').value;
            const lines = text.split('\n').filter(line => line.trim());
            
            const employees = [];
            for (const line of lines) {
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 2) {
                    if (nameOrder === 'first_name') {
                        employees.push({ first_name: parts[0], last_name: parts[1] });
                    } else {
                        employees.push({ first_name: parts[1], last_name: parts[0] });
                    }
                }
            }
            
            if (employees.length === 0) return;
            
            fetch('/employees/bulk-add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ employees: employees })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    document.getElementById('bulkEmployees').value = '';
                    loadEmployees();
                }
            })
            .catch(() => {});
        }
        
        loadEmployees();
        
        loadEmployees();
                    } else {
                        alert('Ошибка: ' + (result.error || 'Unknown error'));
                    }
                });
        }
        
        function editEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            
            document.getElementById('editEmployeeId').value = emp.id;
            document.getElementById('editLastName').value = emp.last_name || '';
            document.getElementById('editFirstName').value = emp.first_name || '';
            document.getElementById('editMiddleName').value = emp.middle_name || '';
            document.getElementById('editDepartment').value = emp.department || '';
            document.getElementById('editPosition').value = emp.position || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editEmployeeModal'));
            modal.show();
        }
        
        document.getElementById('editEmployeeForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const employeeId = document.getElementById('editEmployeeId').value;
            const formData = new FormData();
            formData.append('last_name', document.getElementById('editLastName').value);
            formData.append('first_name', document.getElementById('editFirstName').value);
            formData.append('middle_name', document.getElementById('editMiddleName').value);
            formData.append('department', document.getElementById('editDepartment').value);
            formData.append('position', document.getElementById('editPosition').value);
            
            try {
                const response = await fetch('/employees/update/' + employeeId, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editEmployeeModal')).hide();
                    loadEmployees();
                } else {
                    alert('Ошибка: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Ошибка: ' + err);
            }
        };
        
        loadEmployees();
    </script>
</body>
</html>
