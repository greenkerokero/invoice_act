<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учет счетов и актов</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .form-control, .form-select {
            border-color: #adb5bd; box-shadow: inset 0 1px 3px rgba(0,0,0,0.12);
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea; box-shadow: inset 0 1px 3px rgba(0,0,0,0.12), 0 0 0 0.2rem rgba(102,126,234,0.25);
        }
        .container { max-width: 2200px; }
        .table-wrapper { }
        .filter-zone { background-color: #fff; border-radius: 8px; padding: 10px; margin-bottom: 15px; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; padding-top: 0.3rem; padding-bottom: 0.3rem; }
        .navbar-brand { padding-top: 0.2rem; padding-bottom: 0.2rem; font-size: 1rem; }
        .nav-link { padding: 0.3rem 0.5rem !important; font-size: 0.9rem; }
        .nav-link.active { 
            font-weight: bold; 
            text-decoration: underline;
            background-color: rgba(255,255,255,0.15);
            border-radius: 4px;
        }

        .data-table {
            display: flex;
            flex-direction: column;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background: #fff;
        }
        .data-header {
            display: grid;
            grid-template-columns: var(--cols);
            background-color: #e9ecef;
            font-weight: bold;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
            border: 1px solid #dee2e6;
            border-radius: 4px 4px 0 0;
        }
        .data-header .data-cell { white-space: nowrap; }
        .data-header .data-cell.wrap-header { white-space: normal; line-height: 1.2; }
        .data-header .data-cell.sortable { cursor: pointer; user-select: none; }
        .data-header .data-cell.sortable:hover { background-color: #d3d7db; }
        .data-header .data-cell.sort-asc::after { content: ' ▲'; }
        .data-header .data-cell.sort-desc::after { content: ' ▼'; }
        .data-row-wrapper {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #dee2e6;
        }
        .data-row {
            display: grid;
            grid-template-columns: var(--cols);
            align-items: center;
            padding: 4px 0;
        }
        .data-row:hover { background-color: #f8f9fa; }
        .data-cell {
            padding: 4px 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
        }
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .days-input { width: 100%; min-width: 50px; text-align: center; }
        .data-cell input, .data-cell select { width: 100%; min-width: 0; }
        .data-cell select.form-select-sm { font-size: inherit; }
        .data-cell-btn { overflow: visible; text-overflow: clip; }
        .nested-container {
            display: none;
            background-color: #f8f9fa;
            padding: 10px 20px;
            border-top: 1px dotted #ccc;
        }
        .nested-container.active { display: block; }
        .nested-table {
            border: 1px solid #ced4da;
            background: #fff;
            width: fit-content;
        }
        .nested-table .data-header .data-cell.linked { background-color: #cfe2ff; color: #084298; }
        .nested-table .data-header .data-cell.free { background-color: #f8d7da; color: #842029; }
        .nested-table .data-cell { padding: 4px 6px; font-size: 0.85em; }
        .nested-table-wrapper {
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 3px solid #667eea;
            margin: 5px 0;
        }
        .pagination-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            flex-wrap: wrap;
            font-size: 0.9rem;
        }
        .pagination-bar a, .pagination-bar span.page-link-item {
            cursor: pointer;
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            text-decoration: none;
            color: #495057;
            background: #fff;
            user-select: none;
        }
        .pagination-bar a:hover { background-color: #e9ecef; }
        .pagination-bar a.active { background-color: #667eea; color: #fff; border-color: #667eea; }
        .pagination-bar a.disabled { opacity: 0.5; pointer-events: none; }
        .pagination-bar input.page-size-input {
            width: 50px; text-align: center;
            -moz-appearance: textfield; appearance: textfield;
        }
.pagination-bar input.page-size-input::-webkit-outer-spin-button,
        .pagination-bar input.page-size-input::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        .deadline-warning { background-color: #ffe6e6 !important; }
        .deadline-overdue { background-color: #ffcccc !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-3">
        <div class="container">
            <a class="navbar-brand" href="/">Учет счетов и актов</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="/">Счета</a>
                <a class="nav-link" href="/linked-acts">Привязанные акты</a>
                <a class="nav-link" href="/unlinked-acts">Непривязанные акты</a>
                <a class="nav-link" href="/import">Импорт и Настройки</a>
                <a class="nav-link" href="/employees">Сотрудники</a>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <div class="filter-zone">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Контрагент</label>
                    <select class="form-select" id="filterContractor">
                        <option value="">Все</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Мотивируемый</label>
                    <select class="form-select" id="filterMotivated">
                        <option value="">Все</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Дата оплаты с</label>
                    <input type="date" class="form-control" id="filterDateFrom">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Дата оплаты по</label>
                    <input type="date" class="form-control" id="filterDateTo">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="loadInvoices()">Применить</button>
                </div>
            </div>
        </div>
        
        <div class="table-wrapper">
            <div class="data-header" style="--cols: 26px 6px minmax(60px, 0.8fr) minmax(90px, 1fr) minmax(120px, 3fr) minmax(85px, 0.9fr) minmax(80px, 1fr) minmax(115px, 1.2fr) minmax(115px, 1.2fr) minmax(45px, 0.5fr) minmax(110px, 1.3fr) minmax(140px, 1.8fr) minmax(70px, 0.8fr) minmax(85px, 0.8fr) 36px;">
                    <div class="data-cell"></div>
                    <div class="data-cell"></div>
                    <div class="data-cell">№ счета</div>
                    <div class="data-cell sortable" data-sort="date" onclick="sortBy('date')">Дата</div>
                    <div class="data-cell sortable" data-sort="contractor_name" onclick="sortBy('contractor_name')">Контрагент</div>
                    <div class="data-cell sortable" data-sort="contractor_inn" onclick="sortBy('contractor_inn')">ИНН</div>
                    <div class="data-cell">Сумма</div>
                    <div class="data-cell sortable" data-sort="payment_date" onclick="sortBy('payment_date')">Дата оплаты</div>
                    <div class="data-cell sortable" data-sort="deadline" onclick="sortBy('deadline')">Дедлайн</div>
                    <div class="data-cell">Дней</div>
                    <div class="data-cell sortable" data-sort="responsible_import" onclick="sortBy('responsible_import')">Ответственный</div>
                    <div class="data-cell sortable" data-sort="motivated_person" onclick="sortBy('motivated_person')">Мотивируемый</div>
                    <div class="data-cell sortable" data-sort="acts_count" onclick="sortBy('acts_count')">Акты</div>
                    <div class="data-cell sortable wrap-header" data-sort="free_acts_count" onclick="sortBy('free_acts_count')">Свободные акты</div>
                    <div class="data-cell"></div>
            </div>
            <div class="data-table" id="invoicesTable" style="--cols: 26px 6px minmax(60px, 0.8fr) minmax(90px, 1fr) minmax(120px, 3fr) minmax(85px, 0.9fr) minmax(80px, 1fr) minmax(115px, 1.2fr) minmax(115px, 1.2fr) minmax(45px, 0.5fr) minmax(110px, 1.3fr) minmax(140px, 1.8fr) minmax(70px, 0.8fr) minmax(85px, 0.8fr) 36px;">
                <div id="invoicesBody"></div>
            </div>
        </div>
        <div class="pagination-bar" id="paginationBar"></div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Подтверждение удаления</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Удалить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        const LEGAL_FORMS = ['ооо', 'ип', 'ао', 'зао', 'оао', 'пао', 'нко', 'ано', 'фгуп', 'муп'];
        
        function formatContractorName(name) {
            if (!name) return '';
            const parts = name.trim().split(/\s+/);
            return parts.map(part => {
                if (LEGAL_FORMS.includes(part.toLowerCase())) {
                    return part.toUpperCase();
                }
                return part.charAt(0).toUpperCase() + part.slice(1);
            }).join(' ');
        }
        
        let employees = [];
        let contractors = [];
        let actsVisible = {};
        let currentSort = { field: 'date', direction: 'desc' };
        let allInvoices = [];
        let pageSize = 12;
        let currentPage = 1;
        
        function toggleActs(invoiceId, contractorId) {
            const nested = document.getElementById('nested-' + invoiceId);
            const linkedSection = document.getElementById('linked-acts-content-' + invoiceId);
            const freeSection = document.getElementById('free-acts-content-' + invoiceId);
            
            if (actsVisible[invoiceId]) {
                actsVisible[invoiceId] = false;
                linkedSection.innerHTML = '';
                freeSection.innerHTML = '';
                nested.classList.remove('active');
            } else {
                actsVisible[invoiceId] = true;
                nested.classList.add('active');
                loadLinkedActs(invoiceId);
                loadFreeActs(invoiceId, contractorId);
            }
        }
        
        function parseDateFromString(value) {
            if (!value) return null;
            value = value.trim();
            const formats = [
                /^(\d{4})-(\d{2})-(\d{2})$/,
                /^(\d{2})\.(\d{2})\.(\d{4})$/,
                /^(\d{2})\/(\d{2})\/(\d{4})$/,
                /^(\d{2})-(\d{2})-(\d{4})$/,
            ];
            for (let fmt of formats) {
                const match = value.match(fmt);
                if (match) {
                    if (fmt === formats[0]) {
                        return value;
                    } else {
                        const day = match[1];
                        const month = match[2];
                        const year = match[3];
                        return `${year}-${month}-${day}`;
                    }
                }
            }
            return null;
        }
        
        document.querySelectorAll('input[type="date"]').forEach(input => {
            input.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text');
                const parsedDate = parseDateFromString(pastedData);
                if (parsedDate) {
                    this.value = parsedDate;
                } else {
                    this.value = pastedData;
                }
            });
        });
        
        function formatName(name) {
            if (!name) return '';
            const parts = name.trim().split(/\s+/);
            if (parts.length >= 2) {
                return parts.slice(1).join(' ') + ' ' + parts[0];
            }
            return name;
        }
        
        function loadEmployees() {
            fetch('/employees/list')
                .then(r => r.json())
                .then(data => {
                    employees = data.sort((a, b) => {
                        const nameA = `${a.last_name} ${a.first_name}${a.middle_name ? ' ' + a.middle_name : ''}`;
                        const nameB = `${b.last_name} ${b.first_name}${b.middle_name ? ' ' + b.middle_name : ''}`;
                        return nameA.localeCompare(nameB);
                    });
                    const motivatedSelect = document.getElementById('filterMotivated');
                    motivatedSelect.innerHTML = '<option value="">Все</option>';
                    employees.forEach(e => {
                        const fullName = `${e.last_name} ${e.first_name}${e.middle_name ? ' ' + e.middle_name : ''}`;
                        const option = document.createElement('option');
                        option.value = fullName;
                        option.textContent = fullName;
                        motivatedSelect.appendChild(option);
                    });
                });
        }
        
        function loadContractors() {
            fetch('/contractors/list')
                .then(r => r.json())
                .then(data => {
                    contractors = data.sort((a, b) => a.name.localeCompare(b.name));
                    const contractorSelect = document.getElementById('filterContractor');
                    contractorSelect.innerHTML = '<option value="">Все</option>';
                    contractors.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.name;
                        contractorSelect.appendChild(option);
                    });
                });
        }
        
        function sortBy(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            document.querySelectorAll('.data-header .data-cell.sortable').forEach(cell => {
                cell.classList.remove('sort-asc', 'sort-desc');
                if (cell.dataset.sort === currentSort.field) {
                    cell.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
            
            loadInvoices();
        }
        
        function loadInvoices() {
            const contractorId = document.getElementById('filterContractor').value;
            const motivated = document.getElementById('filterMotivated').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            
            let url = '/invoices/list?';
            if (contractorId) url += `contractor_id=${contractorId}&`;
            if (motivated) url += `motivated_person=${encodeURIComponent(motivated)}&`;
            if (dateFrom) url += `payment_date_from=${dateFrom}&`;
            if (dateTo) url += `payment_date_to=${dateTo}&`;
            url += `sort_by=${currentSort.field}&sort_dir=${currentSort.direction}`;
            
            fetch(url)
                .then(r => r.json())
                .then(invoices => {
                    allInvoices = invoices;
                    currentPage = 1;
                    renderCurrentPage();
                });
        }
        
        function renderCurrentPage() {
            actsVisible = {};
            let paginated;
            if (pageSize === 0) {
                paginated = allInvoices;
            } else {
                const start = (currentPage - 1) * pageSize;
                paginated = allInvoices.slice(start, start + pageSize);
            }
            renderInvoices(paginated);
            renderPagination();
        }
        
        function renderPagination() {
            const bar = document.getElementById('paginationBar');
            if (allInvoices.length === 0) { bar.innerHTML = ''; return; }
            
            const totalPages = pageSize === 0 ? 1 : Math.ceil(allInvoices.length / pageSize);
            let html = '';
            
            html += `<a onclick="setPageSize(12)" class="${pageSize === 12 ? 'active' : ''}">12</a>`;
            html += `<a onclick="setPageSize(24)" class="${pageSize === 24 ? 'active' : ''}">24</a>`;
            html += `<input type="number" class="page-size-input form-control form-control-sm" id="customPageSize" min="1" value="${pageSize || ''}" placeholder="№" onkeydown="if(event.key==='Enter'){event.preventDefault();applyCustomPageSize();}">`;
            html += `<a onclick="applyCustomPageSize()">Применить</a>`;
            html += `<a onclick="showAll()">Все</a>`;
            
            html += `<span style="margin-left:8px;"></span>`;
            
            html += `<a onclick="goToPage(${currentPage - 1})" class="${currentPage <= 1 ? 'disabled' : ''}">Назад</a>`;
            
            if (pageSize > 0) {
                const maxVisible = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
                let endPage = Math.min(totalPages, startPage + maxVisible - 1);
                if (endPage - startPage < maxVisible - 1) {
                    startPage = Math.max(1, endPage - maxVisible + 1);
                }
                
                if (startPage > 1) {
                    html += `<a onclick="goToPage(1)">1</a>`;
                    if (startPage > 2) html += `<span style="padding:4px">...</span>`;
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    html += `<a onclick="goToPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</a>`;
                }
                
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) html += `<span style="padding:4px">...</span>`;
                    html += `<a onclick="goToPage(${totalPages})">Конец</a>`;
                }
            }
            
            html += `<a onclick="goToPage(${currentPage + 1})" class="${currentPage >= totalPages ? 'disabled' : ''}">Вперед</a>`;
            
            html += `<span style="margin-left:8px;color:#888;font-size:0.85rem;">Всего: ${allInvoices.length}</span>`;
            
            bar.innerHTML = html;
        }
        
        function setPageSize(size) {
            pageSize = size;
            currentPage = 1;
            renderCurrentPage();
        }
        
        function applyCustomPageSize() {
            const val = parseInt(document.getElementById('customPageSize').value);
            if (val > 0) {
                pageSize = val;
                currentPage = 1;
                renderCurrentPage();
            }
        }
        
        function showAll() {
            if (!confirm('Будут выведены все строки (' + allInvoices.length + '). Продолжить?')) return;
            pageSize = 0;
            currentPage = 1;
            renderCurrentPage();
        }
        
        function goToPage(page) {
            const totalPages = pageSize === 0 ? 1 : Math.ceil(allInvoices.length / pageSize);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderCurrentPage();
        }
        
        function renderInvoices(invoices) {
            const body = document.getElementById('invoicesBody');
            body.innerHTML = '';
            
invoices.forEach(inv => {
                const wrapper = document.createElement('div');
                wrapper.className = 'data-row-wrapper';
                wrapper.dataset.invoiceId = inv.id;
                wrapper.dataset.contractorId = inv.contractor_id;
                
                let deadlineClass = '';
                if (inv.deadline) {
                    const deadlineDate = new Date(inv.deadline);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    deadlineDate.setHours(0, 0, 0, 0);
                    const daysDiff = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysDiff < 0) {
                        deadlineClass = 'deadline-overdue';
                    } else if (daysDiff <= 10) {
                        deadlineClass = 'deadline-warning';
                    }
                }
                
                const row = document.createElement('div');
                row.className = 'data-row' + (deadlineClass ? ' ' + deadlineClass : '');
                row.innerHTML = `
                    <div class="data-cell data-cell-btn"><button class="btn btn-sm btn-outline-primary" onclick="toggleActs(${inv.id}, ${inv.contractor_id})">+</button></div>
                    <div class="data-cell"></div>
                    <div class="data-cell">${inv.number}</div>
                    <div class="data-cell">${inv.date}</div>
                    <div class="data-cell" title="${formatContractorName(inv.contractor_name) || ''}">${formatContractorName(inv.contractor_name) || ''} <a href="/contractor/${inv.contractor_id}" target="_blank" title="Открыть карточку контрагента" style="text-decoration:none; color:#667eea;">&#8599;</a></div>
                    <div class="data-cell"><input type="text" class="form-control form-control-sm" style="width:100%" value="${inv.contractor_inn || ''}" onchange="updateInn(${inv.contractor_id}, this.value, this)"></div>
                    <div class="data-cell">${inv.amount.toFixed(2)}</div>
                    <div class="data-cell"><input type="date" class="form-control form-control-sm" value="${inv.payment_date || ''}" onchange="updateInvoice(${inv.id}, 'payment_date', this.value, this)"></div>
                    <div class="data-cell">${inv.deadline || ''}</div>
                    <div class="data-cell"><input type="number" 
                           class="form-control form-control-sm days-input" 
                           value="${inv.deadline_days || ''}" 
                           min="0" 
                           placeholder="0" 
                           onkeydown="return event.keyCode !== 189 && event.keyCode !== 109 && event.key !== '-'"
                           oninput="if(this.value < 0) this.value = Math.abs(this.value)"
                           onchange="calculateDeadline(${inv.id}, this.value, this)"></div>
                    <div class="data-cell">${formatName(inv.responsible_import) || ''}</div>
                    <div class="data-cell">
                        <select class="form-select form-select-sm" onchange="updateInvoice(${inv.id}, 'motivated_person', this.value, this)">
                            <option value="">-</option>
                            ${employees.map(e => {
                                const fullName = `${e.last_name} ${e.first_name}${e.middle_name ? ' ' + e.middle_name : ''}`;
                                return `<option value="${fullName}" ${inv.motivated_person === fullName ? 'selected' : ''}>${fullName}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    <div class="data-cell">${inv.acts_count ? inv.acts_count + ' (' + inv.acts_sum.toFixed(2) + ')' : '-'}</div>
                    <div class="data-cell">${inv.free_acts_count > 0 ? inv.free_acts_count : '-'}</div>
                    <div class="data-cell data-cell-btn"><button class="btn btn-sm btn-danger" onclick="confirmDeleteInvoice(${inv.id}, '${inv.number}')">X</button></div>
                `;
                wrapper.appendChild(row);
                
                const nested = document.createElement('div');
                nested.className = 'nested-container';
                nested.id = 'nested-' + inv.id;
                nested.innerHTML = `
                    <div class="nested-section-linked" id="linked-acts-content-${inv.id}"></div>
                    <div class="nested-section-free" id="free-acts-content-${inv.id}" style="margin-top:8px;"></div>
                `;
                wrapper.appendChild(nested);
                
                body.appendChild(wrapper);
            });
            
            document.querySelectorAll('.data-header .data-cell.sortable').forEach(cell => {
                cell.classList.remove('sort-asc', 'sort-desc');
                if (cell.dataset.sort === currentSort.field) {
                    cell.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }
        
        function loadLinkedActs(invoiceId) {
            fetch('/acts/by-invoice/' + invoiceId)
                .then(r => r.json())
                .then(acts => {
                    const container = document.getElementById('linked-acts-content-' + invoiceId);
                    if (acts.length === 0) {
                        container.innerHTML = '<div class="nested-table-wrapper"><h6>Привязанные акты</h6><span class="text-muted d-block">Нет привязанных актов</span></div>';
                        return;
                    }
                    let html = '<div class="nested-table-wrapper"><h6>Привязанные акты</h6><div class="data-table nested-table" style="--cols: 120px 100px 100px 150px 180px;">';
                    html += '<div class="data-header"><div class="data-cell linked">№ акта</div><div class="data-cell linked">Дата</div><div class="data-cell linked">Сумма</div><div class="data-cell linked">Ответственный</div><div class="data-cell linked">Действие</div></div>';
                    acts.forEach(act => {
                        html += `<div class="data-row-wrapper"><div class="data-row">
                            <div class="data-cell">${act.number}</div>
                            <div class="data-cell">${act.signing_date}</div>
                            <div class="data-cell">${act.amount.toFixed(2)}</div>
                            <div class="data-cell">${act.responsible_manager || ''}</div>
                            <div class="data-cell">
                                <button class="btn btn-sm btn-success me-1" onclick="unlinkAct(${act.id})">Отвязать</button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDeleteAct(${act.id}, '${act.number}')">Удалить</button>
                            </div>
                        </div></div>`;
                    });
                    html += '</div></div>';
                    container.innerHTML = html;
                });
        }
        
        function loadFreeActs(invoiceId, contractorId) {
            fetch('/acts/free/' + contractorId)
                .then(r => r.json())
                .then(acts => {
                    const container = document.getElementById('free-acts-content-' + invoiceId);
                    if (acts.length === 0) {
                        container.innerHTML = '<div class="nested-table-wrapper"><h6>Непривязанные акты</h6><span class="text-muted d-block">Нет свободных актов для этого контрагента</span></div>';
                        return;
                    }
                    let html = '<div class="nested-table-wrapper"><h6>Непривязанные акты</h6><div class="data-table nested-table" style="--cols: 120px 100px 100px 150px 180px;">';
                    html += '<div class="data-header"><div class="data-cell free">№ акта</div><div class="data-cell free">Дата</div><div class="data-cell free">Сумма</div><div class="data-cell free">Ответственный</div><div class="data-cell free">Действие</div></div>';
                    acts.forEach(act => {
                        html += `<div class="data-row-wrapper"><div class="data-row">
                            <div class="data-cell">${act.number}</div>
                            <div class="data-cell">${act.signing_date}</div>
                            <div class="data-cell">${act.amount.toFixed(2)}</div>
                            <div class="data-cell">${act.responsible_manager || ''}</div>
                            <div class="data-cell">
                                <button class="btn btn-sm btn-success me-1" onclick="linkAct(${act.id}, ${invoiceId})">Привязать</button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDeleteAct(${act.id}, '${act.number}')">Удалить</button>
                            </div>
                        </div></div>`;
                    });
                    html += '</div></div>';
                    container.innerHTML = html;
                });
        }
        
        function updateInvoice(invoiceId, field, value, inputEl) {
            const formData = new FormData();
            formData.append(field, value);
            fetch('/invoice/update/' + invoiceId, {
                method: 'POST',
                body: formData
            });
        }
        
        function updateInn(contractorId, inn, inputEl) {
            fetch('/contractor/update-inn/' + contractorId, {
                method: 'POST',
                body: new URLSearchParams({ inn: inn })
            });
        }
        
        function calculateDeadline(invoiceId, days, inputEl) {
            const daysNum = parseInt(days);
            if (!days || isNaN(daysNum) || daysNum < 0) return;
            
            fetch('/invoice/calculate-deadline/' + invoiceId, {
                method: 'POST',
                body: new URLSearchParams({ days: days })
            }).then(r => r.json())
              .then(result => {
                  if (result.success) {
                      const wrapper = inputEl.closest('.data-row-wrapper');
                      const cells = wrapper.querySelector('.data-row').querySelectorAll('.data-cell');
                      cells[8].textContent = result.deadline;
                      loadInvoices();
                  } else {
                      alert(result.error || 'Ошибка расчёта дедлайна');
                  }
              });
        }
        
        function updateAct(actId, field, value) {
            const formData = new FormData();
            formData.append(field, value);
            fetch('/act/update/' + actId, {
                method: 'POST',
                body: formData
            });
        }
        
        function linkAct(actId, invoiceId) {
            const formData = new FormData();
            formData.append('invoice_id', invoiceId);
            fetch('/act/link/' + actId, {
                method: 'POST',
                body: formData
            }).then(() => loadInvoices());
        }
        
        function unlinkAct(actId) {
            if (!confirm('Отвязать акт от счёта?')) return;
            fetch('/act/unlink/' + actId, { method: 'POST' })
                .then(() => loadInvoices());
        }
        
        let pendingDeleteType = null;
        let pendingDeleteId = null;
        
        function confirmDeleteInvoice(invoiceId, invoiceNumber) {
            pendingDeleteType = 'invoice';
            pendingDeleteId = invoiceId;
            document.getElementById('deleteConfirmMessage').textContent = 'Вы уверены, что хотите удалить счёт №' + invoiceNumber + '?';
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }
        
        function confirmDeleteAct(actId, actNumber) {
            pendingDeleteType = 'act';
            pendingDeleteId = actId;
            document.getElementById('deleteConfirmMessage').textContent = 'Вы уверены, что хотите удалить акт №' + actNumber + '?';
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }
        
        document.getElementById('confirmDeleteBtn').onclick = function() {
            if (pendingDeleteType === 'invoice') {
                deleteInvoice(pendingDeleteId);
            } else if (pendingDeleteType === 'act') {
                deleteAct(pendingDeleteId);
            }
            bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
        };
        
        function deleteInvoice(invoiceId) {
            fetch('/invoice/delete/' + invoiceId, { method: 'POST' })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        loadInvoices();
                    } else {
                        alert('Ошибка удаления: ' + (result.error || 'Unknown error'));
                    }
                });
        }
        
        function deleteAct(actId) {
            fetch('/act/delete/' + actId, { method: 'POST' })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        loadInvoices();
                    } else {
                        alert('Ошибка удаления: ' + (result.error || 'Unknown error'));
                    }
                });
        }
        
        loadEmployees();
        loadContractors();
        
        document.querySelectorAll('.data-header .data-cell.sortable').forEach(cell => {
            if (cell.dataset.sort === currentSort.field) {
                cell.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        });
        
        loadInvoices();
    </script>
</body>
</html>
